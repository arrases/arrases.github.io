<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ubicaciones</title>
    <style>
        body {
            background-color: #ddddff;
            font-family: sans-serif;
            font-size: large;
            padding: 0;
        }

        body > * {
            margin: 0 auto;
        }

        h1 {
            font-size: 1.5rem;
            border-bottom: 1px solid;
        }

        h1:first-child {
            margin-top: 0;
        }

        section {
            padding: .5rem;
            border-radius: .5rem;
            border: 1px solid #ccc;
        }

        nav {
            text-align: center;
        }

        footer {
            text-align: right;
            padding: .5em;
        }

        input, button {
            font-size: inherit;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            font-size: .9em;
            padding: .25rem 0;
        }

        li > input {
            margin: 0 .5rem 0 0;
        }

        #sugerencias {
            list-style: inside;
        }

        #sugerencias>li:nth-child(2n) {
            background-color: #f1f1f1;
        }

        @media only screen and (min-width: 992px) {
            body { font-size: 1rem !important; }
            body > * { max-width: 70%; }
            section { padding: 1rem; }
        }
    </style>
</head>
<body>
    <section>
        <h1>Ubicaciones</h1>
        <ul id="ubicaciones"></ul>
        <nav>
            <button onclick="borrar()">borrar</button>
            <button onclick="mover(true)">subir</button>
            <button onclick="mover(false)">bajar</button>
            <button onclick="vaciar()">vaciar</button>
        </nav>

        <h1>Buscar</h1>
        <nav>
            <input id="buscar" placeholder="Buscar" />
            <button onclick="buscar()">Buscar</button>
        </nav>
        <ul id="sugerencias"></ul>
    </section>
    <footer>
        <a href="#" onclick="history.back()">volver</a>
    </footer>

    <script src="jquery-3.1.1.min.js"></script>
    <script>
        const STORAGEKEY = "almiji.locations";
        let id = 0;
        document.querySelector('#buscar').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                buscar();
            }
        });

        function cargarUbicaciones() {
            $("#ubicaciones > li").remove();
            const ubicaciones = JSON.parse(localStorage.getItem(STORAGEKEY) || "[]");
            for (const ubicacion of ubicaciones) {
                $("#ubicaciones").append(crearUbicacion(ubicacion));
            }
        }

        function crearUbicacion(data) {
            const idt = `ckbx-${Math.floor(Math.random() * 26) + Date.now()}${id++}`;
            return $("<li>")
                .data(data)
                .append($(`<input type="checkbox" id="${idt}">`))
                .append(
                    $(`<label for="${idt}">`)
                        .html(`${data.n} [${data.c}] (${data.e || "-"} m)`)
                        .on("dblclick", () => {
                            const $li = $($(event.target).closest("li")); 
                            let ubicacion = $li.data();
                            const nuevoNombre = prompt("Nuevo nombre", ubicacion.n) || ubicacion.n;
                            ubicacion.n = nuevoNombre;
                            $li.data(ubicacion);
                            guardarUbicaciones();
                            cargarUbicaciones();
                        })
                );
        }

        function guardarUbicaciones() {
            const ubicaciones = [];
            $("#ubicaciones > li").each( (i, e) => ubicaciones.push($(e).data()) );
            localStorage.setItem(STORAGEKEY, JSON.stringify(ubicaciones));
        }

        function normalizarCoord(val) {
            return parseFloat(val.toFixed(6));
        }

        async function buscar() {
            const termino = $("#buscar").val();
            if (!termino || termino.length < 4) {
                alert("Especifica un poco más...");
                return;
            }
            try {
                const resultado = await $.getJSON(`https://nominatim.openstreetmap.org/search?q=${termino}&format=geojson&extratags=1`);
                if (!resultado || resultado.features.length === 0) {
                    alert("No hay resultados :(");
                    return;
                }
                $("#sugerencias").empty();
                for (const feature of resultado.features) {
                    if (!["city", "town", "village", "locality", "neighbourhood", "road", "peak"].includes(feature.properties.addresstype)) {
                        continue;
                    }
                    const $li = $("<li>")
                        .append(feature.properties.display_name)
                        .data({
                            "n": feature.properties.name,
                            "c": [normalizarCoord(feature.geometry.coordinates[1]), normalizarCoord(feature.geometry.coordinates[0])],
                            "e": feature.properties?.extratags?.ele ?? null,
                        })
                        .on("click", async (e) => {
                            const $li = $(e.target);
                            $li.data(await crearNuevaUbicacion({ ...$li.data() }));
                            $("#ubicaciones").append(crearUbicacion($li.data()));
                            guardarUbicaciones();
                        })
                        ;
                    $("#sugerencias").append($li);
                }
                if ($("#sugerencias").children().length === 0) {
                    alert("No hay resultados :(");
                }
            } catch (err) {
                console.error("Error en buscar", err);
                alert("Ha ocurrido un error");
            }
        }

        async function crearNuevaUbicacion(data) {
            data.e ??= await getElevacion(data.c);
            return data;
        }

        async function getElevacion(coords) {
            try {
                const response = await $.ajax({
                    url: "https://api.open-elevation.com/api/v1/lookup",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ locations: [{ latitude: coords[0], longitude: coords[1] }] })
                });
                if (response && response.results && response.results.length > 0) {
                    return response.results[0].elevation;
                }
            } catch (error) {
                console.error(`Error al obtener elevación de ${coords}`, err);
            } finally {
                return null;
            }
        }

        function borrar() {
            for (const $elem of elegidos()) {
                $elem.remove();
            }
            guardarUbicaciones();
        }

        function mover(arriba) {
            for (const $elem of elegidos()) {
                if (arriba) {
                    $before = $elem.prev();
                    $elem.insertBefore($before);
                } else {
                    $after = $elem.next();
                    $elem.insertAfter($after);
                }
            }
            guardarUbicaciones();
        }

        function vaciar() {
            if (window.confirm("¿Quieres eliminar todas las ubicaciones?")) {
                $("#ubicaciones").empty();
                guardarUbicaciones();
            }
        }

        function elegidos() {
            const chosen = [];
            $("#ubicaciones input:checked").each((i, e) => {
                chosen.push($(e).parent());
            });
            return chosen;
        }

        cargarUbicaciones();

        // Maps: https://leafletjs.com/
        // https://stackoverflow.com/questions/925164/openstreetmap-embedding-map-in-webpage-like-google-maps
    </script>
</body>

</html>