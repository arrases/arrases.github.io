<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no" />
	<style>
		body {
			font-family: sans-serif;
			font-size: 1rem;
		}

		body > div {
			border: 1px solid #bbb;
			margin: .4rem;
			display: inline-block;
			padding: .2rem;
		}

		@media (max-width: 425px) {
			body > div {
				display: block;
			}
		}

		body > div > a {
			display: block;
			text-align: center;
			cursor: pointer;
		}

		.mto {
			display: inline-block;
			min-width: 10rem;
			max-width: 20rem;
			border: 1px solid #eee;
			padding: .5rem;
			max-height: 33rem;
    		overflow: auto;
			font-size: small;
		}

		.mto > h4 {
			border-top: 1px solid black;
			margin: .75rem 0 0 0;
			display: flex;
		}

		.mto > div {
			display: flex;
			border-top: 1px solid #eee;
		}
	
		.mto span {
			flex: 1;
			padding: .15rem;
			margin: 0 .1rem;
			flex-basis: auto;
			border-radius: .25rem;
    		text-align: center;
		}

		span::after {
			font-size: .5rem;
			vertical-align: super;
		}

		.tc::after { content: 'ºC'; }
		.pc::after { content: '%'; }
		.mm::after { content: 'mm'; }
		.pr::after { content: 'hPa'; }
		.ws::after { content: 'Km/h'; }
		.mx::before { content: "\25B2"; }
		.mn::before { content: "\25BC"; }
		.wd::before { content: "\2193"; }

		button.on {
			background-color: lime;
		}
	</style>
</head>
<body>
	<header></header>
	<div>
		<a onclick="pronostico2(0);">Geolocalización</a>
	</div>
	<div>
		<a onclick="pronostico2(1);">Zizurkil</a>
	</div>
	<div>
		<a onclick="pronostico2(2);">Mambrillas de Lara</a>
	</div>
	<div>
		<a onclick="pronostico2(3);">Santa Pola</a>
	</div>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script>
		var ARR_D100 = [0, 10,20,30,40,50,60,70,80,90,100];

		var ESCALA_TEMPERATURA = {
			val: [-99,-50,-40,-35,-30,-28,-26,-24,-22,-20,-18,-16,-14,-12,-10,-8,-6,-4,-2,0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50],
			col: ["#640050","#730064","#820078","#91008c","#a01ea0","#aa2daf","#b446be","#aa4bc3","#a050c8","#9646cd","#8c3cd2","#8232d7","#7828dc","#6e1ee1","#326ecd","#4682d7","#5a96e1","#6eaaeb","#64b9f5","#50be82","#5ac832","#6ed73c","#82e646","#96f05a","#ffff64","#fffa50","#fff03c","#ffdc32","#ffc832","#ffb432","#ffa000","#ff8c00","#ff7800","#ff6900","#f03c14","#dc3c14","#c81e0f","#b4000f","#a0000f","#82001e","#a00546","#c80a64","#dc3282","#f064a0","#ff82be"]
		};

		var ESCALA_NUBES = {
			val: ARR_D100,
			col: ["#fff","#F0F0F5","#E0E0EB","#D1D1E0","#C2C2D6","#B2B2CC","#A3A3C2","#9494B8","#8585AD","#7575A3","#666699"]
		};

		var ESCALA_PRECIP = {
			val: [0,1,2,4,6,8,10,12,14,16,20,26,35,43,51,65,75,85,95,105,115],
			col: ["#ccffff","#c7f7ff","#c2f0ff","#bde8ff","#b8e0ff","#b2d9ff","#add1ff","#a8c9ff","#a3c2ff","#9ebaff","#99b2ff","#94abff","#8fa3ff","#8a9cff","#8594ff","#808cff","#7a85ff","#757dff","#7075ff","#6b6eff","#6666ff"]
		}

		var ESCALA_HUMEDAD = {
			val: ARR_D100,
			col: ["#EBEBFF","#D6D6FF","#C2C2FF","#ADADFF","#9999FF","#8585FF","#7070FF","#5C5CFF","#4747FF","#3333FF"]
		};
		
		var ESCALA_VIENTO = {
			val: [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110],
			col: ["#ccffcc","#c2f5c2","#b8ebb8","#ade0ad","#a3d6a3","#99cc99","#8fc28f","#85b885","#7aad7a","#70a370","#669966","#5c8f5c","#528552","#477a47","#3d703d","#336633","#295c29","#1f521f","#144714","#0a3d0a","#003300"]
		};

		var ESCALA_RADIACION = {
			val: [0,1,3,5,7,8,9,10,11,12],
			col: ["#fff","#ffe6e6","#ffb3b3","#ff9999","#ff6666","#ff4d4d","#ff1a1a","#ff0000","#e60000","#cc0000","#b30000","#990000","#800000","#660000","#4d0000"]
		};

		function getFromEscala (escala, valor) {
			var i = 0;
			while (i < escala.val.length - 1) {
				if (escala.val[i] <= valor && valor < escala.val[i + 1]) {
					return escala.col[i];
				}
				i++;
			}
			return escala.col[escala.col.length - 1];
		}

		function colorear ($contenedor) {
			var addColor = function (el, escala) {
				var val = parseFloat($(el).html());
				if (val === 0.0 || isNaN(val)) {
					$(el).html("&minus;");
					return;
				}
				$(el).css("background-color", getFromEscala(escala, val));
			};
			$contenedor.find(".tc").each((i, el) => addColor(el, ESCALA_TEMPERATURA));
			$contenedor.find(".nu").each((i, el) => addColor(el, ESCALA_NUBES));
			$contenedor.find(".hu").each((i, el) => addColor(el, ESCALA_HUMEDAD));
			$contenedor.find(".ws").each((i, el) => addColor(el, ESCALA_VIENTO));
			$contenedor.find(".mm").each((i, el) => addColor(el, ESCALA_PRECIP));
			$contenedor.find(".uv").each((i, el) => addColor(el, ESCALA_RADIACION));
		}

		function cargarPrediccion ($mto, data) {
			var clickCabecera = function (e) {
				var visible = null;
				var $el = $(e.currentTarget).next();
				while ($el.length > 0 && $el[0].tagName !== "H4") {
					if (visible === null) {
						visible = !$el.is(":visible");
					}
					$el.toggle(visible);
					$el = $el.next();
				}
			};

			var ultimoDia = null;
			var $tMax, $tMin, $pr, $vi;
			var tMax = -999, tMin = 999, pr = 0.0, vi = 0;
			for (var i = 0; i < data.length; i++) {
				var d = data[i];
				if (ultimoDia !== d.fech.getDate()) {
					ultimoDia = d.fech.getDate();
					if ($tMax !== undefined) {
						$tMax.html(tMax);
						$tMin.html(tMin);
						$pr.html(pr.toFixed(1));
						$vi.html(vi);
						tMax = -999, tMin = 999, pr = 0.0, vi = 0;
					}
					$tMax = newSpan("", "mx tc");
					$tMin = newSpan("", "mn tc");
					$pr = newSpan("", "mm");
					$vi = newSpan("", "ws");
					$mto.append(
						$("<h4>")
							.append(newSpan(formateaDate(d.fech)))
							.append($tMax)
							.append($tMin)
							.append($pr)
							.append($vi)
							.on("click", clickCabecera)
					);
				}
				tMax = Math.max(tMax, d.temp);
				tMin = Math.min(tMin, d.temp);
				pr += d.prec;
				vi = Math.max(vi, d.vien);
				$mto.append(
					$("<div>")
						.append(newSpan(formateaDate(d.fech, "HH")))
						.append(newSpan("OO"))
						.append(newSpan(d.temp, "tc"))
						.append(newSpan(d.nubo, "pc nu"))
						.append(newSpan(d.prec.toFixed(1), "mm"))
						.append(newSpan(d.hume, "pc hu"))
						.append(newSpan(d.pres, "pr"))
						.append(newSpan(d.vien, "ws"))
						.append(`<span class="wd" style="transform: rotate(${d.vdir}deg);"></span>`)
						.append(newSpan(d.radi, "uv"))
				);
				if (i === data.length - 1) {
					$tMax.html(tMax);
					$tMin.html(tMin);
					$pr.html(pr.toFixed(1));
					$vi.html(vi);
				}
			}

			colorear($mto);
		}

		function pronostico (e, data) {
			e = e || event;
			data = data || Converters.wunderground(dataWG);
			var $par = $(e.target).parent();
			$par.find(".mto").remove();
			var $mto = $('<div class="mto">');
			$par.append($mto);
			cargarPrediccion($mto, data);
		}

		function pronostico2 (g) {
			var ev = event;
			getPosicion(g).then(function (p) {
				console.log("Geoposición", p);
				var src = $("header > button.on").html();
				var url = getUrl(src, p);
				console.log(url, ev);
				$.ajax(url).done(function (d) {
					var data = Converters[src](d);
					var $par = $(ev.target).parent();
					$par.find(".mto").remove();
					var $mto = $('<div class="mto">');
					$par.append($mto);
					cargarPrediccion($mto, data);
				});
			});
		}
		
		function getPosicion (g) {
			return new Promise(function (resolve, reject) {
				switch (g) {
					case 1:
						resolve([43.193777,-2.058095]);	//Zizurkil
						break;
					case 2:
						resolve([42.094992,-3.460735]);	//Mambrillas de Lara
						break;
					case 3:
						resolve([38.194851,-0.569823]);	//Santa Pola
						break;
					default:
						navigator.geolocation.getCurrentPosition(function (p) {
							resolve([p.coords.latitude, p.coords.longitude]);
						}, function (err) {
							console.error(err);
							alert(err);
							reject(err);
						}, {
							enableHighAccuracy: true,
							timeout: 10000,
							maximumAge: 0
						});
				}
			});
		}

		function getUrl (src, coords) {
			const DECIMALES = 3;
			var url = Sources[src];
			url = url.replace("#", coords[0].toFixed(DECIMALES));
			url = url.replace("#", coords[1].toFixed(DECIMALES));
			return url;
		}

		function formateaDate (fecha, formato) {
			const dias = ["D", "L", "M", "X", "J", "V", "S"];
			switch (formato) {
				case "HH":
					return fecha.getHours() < 10 ? "0" + fecha.getHours() : fecha.getHours();
				default:
					return `${fecha.getDate()}/${fecha.getMonth() + 1} ${dias[fecha.getDay()]}`;
			}
		}

		function newSpan (contenido, clase) {
			if (contenido === undefined) {
				return "";
			}
			return $(`<span class="${clase ? clase : ''}">${contenido}</span>`);
		}

		const Sources = {
			"openweathermap": "https://api.openweathermap.org/data/2.5/forecast?lat=#&lon=#&lang=es&units=metric&APPID=e3993f2ed6f2dd3b82764b0fc55d3f2c",
			"wunderground": "https://api.wunderground.com/api/3b0231f0d1ebf323/hourly10day/lang:SP/q/#,#.json",
			"forecastio": "https://api.forecast.io/forecast/a48eb522ce6b50ffcb1b69cf4655c8eb/#,#?units=si&lang=es" /*TODO FIX*/
		};

		var Converters = {
			"wunderground": function (data) {
				var r = [];
				data = data.hourly_forecast;
				for (var i = 0; i < data.length; i++) {
					var m = {}, d = data[i];
					m.fech = new Date(d.FCTTIME.epoch * 1000);
					m.temp = d.temp.metric;
					m.nubo = d.sky;
					m.hume = d.humidity;
					m.pres = d.mslp.metric;
					m.prec = parseFloat(d.qpf.metric);
					m.vien = d.wspd.metric;
					m.vdir = d.wdir.degrees;
					m.radi = d.uvi;
					r.push(m);
				}
				return r;
			},
			"openweathermap": function (data) {
				var r = [];
				data = data.list;
				for (var i = 0; i < data.length; i++) {
					var m = {}, d = data[i];
					m.fech = new Date(d.dt * 1000);
					m.temp = d.main.temp.toFixed(1);
					m.ciel = d.weather.id;
					m.nubo = d.clouds.all;
					m.hume = d.main.humidity;
					m.pres = d.main.pressure.toFixed(0);
					m.prec = (d.rain && d.rain["3h"]) ? d.rain["3h"] : 0.0;
					m.vien = parseFloat(d.wind.speed * 3.6).toFixed(1);
					m.vdir = d.wind.deg;
					r.push(m);
				}
				return r;
			},
			"forecastio": function (data) {
				var r = [];
				data = data.hourly.data;
				for (var i = 0; i < data.length; i++) {
					var m = {}, d = data[i];
					m.fech = new Date(d.time * 1000);
					m.temp = d.temperature.toFixed(1);
					m.ciel = d.weather.id;
					m.nubo = d.cloudCover * 100;
					m.hume = d.humidity * 100.0;
					m.pres = d.pressure.toFixed(0);
					m.prec = d.precipIntensity;
					m.vien = parseFloat(d.windGust * 3.6).toFixed(1);
					m.vdir = d.windBearing;
					m.radi = d.uvIndex;
					r.push(m);
				}
				return r;
			}
		};

		function elegirFuente () {
			var $este = $(event.target);
			$este.parent().children().removeClass("on");
			$este.addClass("on");
		}

		(function crearFuentes () {
			var keys = Object.keys(Sources);
			for (var i = 0; i < keys.length; i++) {
				var $b = $(`<button>${keys[i]}</button>`);
				$b.on("click", function elegirFuente (e) {
					var $este = $(e.target);
					$este.parent().children().removeClass("on");
					$este.addClass("on");
				});
				if (i === 0) {
					$b.addClass("on");
				}
				$("header").append($b);
			}
		}());
	</script>
</body>
</html>

